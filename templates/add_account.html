<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>添加账号</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .error-message {
      color: red;
      font-size: 0.9em;
      display: none;
    }
    .form-group {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">OpenVPN CCD配置管理</a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">首页</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/accounts">账号管理</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/templates">模板管理</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/logs">日志</a>
        </li>
      </ul>
    </div>
    <div class="navbar-nav">
                <span class="navbar-text me-3">
                    欢迎，{{.user}}
                </span>
      <a class="nav-link" href="/logout">退出登录</a>
    </div>
  </div>
</nav>

<div class="container mt-5">
  <h1 class="mb-4">添加账号</h1>

  <form id="addAccountForm">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label for="username" class="form-label">用户名</label>
          <input type="text" class="form-control" id="username" required>
          <div id="usernameError" class="error-message"></div>
        </div>

        <div class="form-group">
          <label for="password" class="form-label">密码</label>
          <input type="password" class="form-control" id="password" required>
          <div id="passwordError" class="error-message"></div>
        </div>

        <div class="form-group">
          <label for="displayName" class="form-label">中文名称</label>
          <input type="text" class="form-control" id="displayName" required>
          <div id="displayNameError" class="error-message"></div>
        </div>

        <div class="form-group">
          <label for="email" class="form-label">邮箱</label>
          <input type="email" class="form-control" id="email" required>
          <div id="emailError" class="error-message"></div>
        </div>

        <div class="form-group">
          <label for="phone" class="form-label">手机号</label>
          <input type="tel" class="form-control" id="phone" required>
          <div id="phoneError" class="error-message"></div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="form-group">
          <label class="form-label">账号类型</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="accountType" id="irouteType" value="iroute">
            <label class="form-check-label" for="irouteType">
              IRoute账号 (添加 iroute 路由)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="accountType" id="normalType" value="normal" checked>
            <label class="form-check-label" for="normalType">
              普通账号 (关联iroute路由)
            </label>
          </div>
        </div>

        <div class="form-group" id="irouteRouteField" style="display: none;">
          <label for="irouteRoute" class="form-label">IRoute路由 (例如: 10.8.0.0 255.255.255.0)</label>
          <div id="irouteRoutesContainer">
            <input type="text" class="form-control" id="irouteRoute" placeholder="输入IRoute路由 10.8.0.0 255.255.255.0">
            <button class="btn btn-outline-secondary" type="button" onclick="addIRouteRouteInput()">+</button>
          </div>
          <div id="irouteRouteError" class="error-message"></div>
        </div>

        <div class="form-group" id="normalRouteField">
          <label for="normalRoute" class="form-label">路由信息 (例如: 192.168.1.0 255.255.255.0)</label>
          <div id="normalRoutesContainer">
            <input type="text" class="form-control" id="normalRoute" placeholder="输入IRoute路由 10.8.0.0 255.255.255.0">
            <button class="btn btn-outline-secondary" type="button" onclick="addNormalRouteInput()">+</button>
          </div>
          <div id="normalRouteError" class="error-message"></div>
        </div>

        <div class="form-group" id="templateField">
          <label for="templateId" class="form-label">选择模板</label>
          <select class="form-control" id="templateId">
            <option value="">不使用模板</option>
            {{range .templates}}
            <option value="{{.ID}}">{{.Name}} ({{.Type}} - {{len .IRoutes}}个路由)</option>
            {{end}}
          </select>
        </div>

        <div class="form-group" id="irouteSelectionField" style="display: none;">
          <label class="form-label">选择关联的IRoute路由</label>
          <div class="form-check form-check-inline" style="max-height: 200px; overflow-y: auto; display: block;">
            {{range .irouteAccounts}}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="iroute_{{.ID}}" value="{{.ID}}">
              <label class="form-check-label" for="iroute_{{.ID}}">
                {{.Username}} ({{.IRouteValue}})
              </label>
            </div>
            {{end}}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">账号状态</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="enabled" checked>
            <label class="form-check-label" for="enabled">
              启用此账号
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <button type="submit" class="btn btn-primary">保存</button>
      <a href="/" class="btn btn-secondary">取消</a>
    </div>
  </form>
</div>

<script>
  // 显示错误信息
  function showError(elementId, message) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.style.display = 'block';
  }

  // 隐藏错误信息
  function hideError(elementId) {
    const element = document.getElementById(elementId);
    element.style.display = 'none';
  }

  // 验证邮箱格式
  function validateEmail(email) {
    const re = /^[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,4}$/;
    return re.test(email);
  }

  // 验证手机号格式
  function validatePhone(phone) {
    const re = /^1[3-9]\d{9}$/;
    return re.test(phone);
  }

  // 验证路由格式
  function validateRoute(route) {
    const re = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3} \d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
    return re.test(route);
  }

  // 监听账号类型变化
  document.getElementById('irouteType').addEventListener('change', function() {
    document.getElementById('irouteRouteField').style.display = this.checked ? 'block' : 'none';
    document.getElementById('normalRouteField').style.display = this.checked ? 'none' : 'block';
    document.getElementById('templateField').style.display = this.checked ? 'none' : 'block';
    document.getElementById('irouteSelectionField').style.display = this.checked ? 'none' : 'block';
  });

  document.getElementById('normalType').addEventListener('change', function() {
    document.getElementById('irouteRouteField').style.display = this.checked ? 'none' : 'block';
    document.getElementById('normalRouteField').style.display = this.checked ? 'block' : 'none';
    document.getElementById('templateField').style.display = this.checked ? 'block' : 'none';
    document.getElementById('irouteSelectionField').style.display = this.checked ? 'block' : 'none';
  });

  // 监听模板选择变化
  document.getElementById('templateId').addEventListener('change', function() {
    const templateId = this.value;
    const irouteCheckboxes = document.querySelectorAll('#irouteSelectionField input[type="checkbox"]');

    // 如果选择了模板，禁用IRoute选择
    if (templateId) {
      irouteCheckboxes.forEach(checkbox => {
        checkbox.disabled = true;
        checkbox.checked = false;
      });
    } else {
      irouteCheckboxes.forEach(checkbox => {
        checkbox.disabled = false;
      });
    }
  });
  // 添加IRoute路由输入框
  function addIRouteRouteInput() {
    const container = document.getElementById('irouteRoutesContainer');
    const newInput = document.createElement('div');
    newInput.className = 'input-group mb-3';
    newInput.innerHTML = `
      <input type="text" class="form-control irouteRouteInput" id="irouteRoute" placeholder="输入IRoute路由">
      <button class="btn btn-outline-secondary" type="button" onclick="removeRouteInput(this)">-</button>
    `;
    container.appendChild(newInput);
  }

  // 添加普通路由输入框
  function addNormalRouteInput() {
    const container = document.getElementById('normalRoutesContainer');
    const newInput = document.createElement('div');
    newInput.className = 'input-group mb-3';
    newInput.innerHTML = `
      <input type="text" class="form-control normalRouteInput" id="normalRoute" placeholder="输入路由信息">
      <button class="btn btn-outline-secondary" type="button" onclick="removeRouteInput(this)">-</button>
    `;
    container.appendChild(newInput);
  }

  // 移除路由输入框
  function removeRouteInput(button) {
    const inputGroup = button.closest('.input-group');
    inputGroup.remove();
  }

  // 验证多个路由格式
  function validateRoutes(inputElements) {
    const routes = [];
    let isValid = true;
    inputElements.forEach(input => {
      const route = input.value.trim();
      if (route) {
        if (!validateRoute(route)) {
          isValid = false;
        }
        routes.push(route);
      }
    });
    return { isValid, routes };
  }

  // 提交表单
  document.getElementById('addAccountForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // 清除所有错误信息
    const errorElements = document.querySelectorAll('.error-message');
    errorElements.forEach(el => el.style.display = 'none');

    // 验证表单
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const displayName = document.getElementById('displayName').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const isIRoute = document.getElementById('irouteType').checked;
    let route = '';

    if (username === '') {
      showError('usernameError', '用户名不能为空');
      return;
    }

    if (password === '') {
      showError('passwordError', '密码不能为空');
      return;
    }

    if (displayName === '') {
      showError('displayNameError', '中文名称不能为空');
      return;
    }

    if (email === '') {
      showError('emailError', '邮箱不能为空');
      return;
    } else if (!validateEmail(email)) {
      showError('emailError', '邮箱格式不正确');
      return;
    }

    if (phone === '') {
      showError('phoneError', '手机号不能为空');
      return;
    } else if (!validatePhone(phone)) {
      showError('phoneError', '手机号格式不正确');
      return;
    }

    // if (isIRoute) {
    //   route = document.getElementById('irouteRoute').value.trim();
    //   if (route === '') {
    //     showError('irouteRouteError', 'IRoute账号需要填写路由信息');
    //     return;
    //   } else if (!validateRoute(route)) {
    //     showError('irouteRouteError', '路由格式不正确，应为 "IP地址 子网掩码"');
    //     return;
    //   }
    // } else {
    //   route = document.getElementById('normalRoute').value.trim();
    //   if (route === '') {
    //     showError('normalRouteError', '普通账号需要填写路由信息');
    //     return;
    //   } else if (!validateRoute(route)) {
    //     showError('normalRouteError', '路由格式不正确，应为 "IP地址 子网掩码"');
    //     return;
    //   }
    // }
    // 构建账号数据
    const accountData = {
      username: username,
      password: password,
      display_name: displayName,
      email: email,
      phone: phone,
      is_iroute: isIRoute,
      route: route,
      i_route_value: isIRoute ? route : '',
      enabled: document.getElementById('enabled').checked
    };
    if (isIRoute) {
      const irouteInputs = document.querySelectorAll('.irouteRouteInput');
      const { isValid, routes } = validateRoutes(irouteInputs);
      if (!isValid) {
        showError('irouteRouteError', '部分IRoute路由格式不正确，应为 "IP地址 子网掩码"');
        return;
      }
      if (routes.length === 0) {
        showError('irouteRouteError', 'IRoute账号需要填写至少一个路由信息');
        return;
      }
      accountData.i_route_value = routes;
    } else {
      const normalInputs = document.querySelectorAll('.normalRouteInput');
      const { isValid, routes } = validateRoutes(normalInputs);
      if (!isValid) {
        showError('normalRouteError', '部分路由格式不正确，应为 "IP地址 子网掩码"');
        return;
      }
      if (routes.length === 0) {
        showError('normalRouteError', '普通账号需要填写至少一个路由信息');
        return;
      }
      accountData.route = routes;
    }


    // 处理模板和IRoute关联
    if (!isIRoute) {
      const templateId = document.getElementById('templateId').value;
      if (templateId) {
        accountData.template_id = parseInt(templateId);
      } else {
        // 获取选中的IRoute账号
        const selectedIRouteIds = [];
        document.querySelectorAll('#irouteSelectionField input[type="checkbox"]:checked').forEach(checkbox => {
          selectedIRouteIds.push(parseInt(checkbox.value));
        });

        // if (selectedIRouteIds.length === 0) {
        //   alert('普通账号必须选择至少一个IRoute路由或关联一个模板');
        //   return;
        // }
      }
    }

    // 提交数据
    fetch('/api/accounts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(accountData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.message) {
                alert(data.message);
                window.location.href = '/';
              } else {
                alert(data.error || "保存失败");
              }
            })
            .catch(error => {
              alert("保存失败: " + error.message);
            });
  });
</script>
</body>
</html>